#!/bin/bash
set -e

cd $(dirname $0)/..

function echoexec() {
  echo $@
  $@
}

cd files

for file in $(git ls-files); do
  target=$HOME/$file

  if [ ! -h $target ]; then
    if [ -f $target ]; then
      echoexec mv $target $target.backup
    fi

    echoexec ln -sfn $(pwd)/$file $target
  fi
done

if ! type brew &>/dev/null; then
  $(command -v ruby) -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

set -v

brew update

brew upgrade

brew install \
  bash-completion \
  coreutils \
  git \
  ncdu \
  htop \
  neovim \
  tree

brew cask install \
  google-backup-and-sync \
  google-chrome \
  keepassx \
  postman \
  slack \
  spotify \
  visual-studio-code

brew cleanup

brew doctor || true

git config --global core.editor "code --wait"
git config --global core.excludesfile "~/.gitignore"
git config --global fetch.prune true

echo "setup complete"

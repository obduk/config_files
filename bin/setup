#!/bin/bash
set -e

cd $(dirname $0)/..

function install_nvm() {
  if ! type nvm &>/dev/null; then
    curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.34.0/install.sh | bash
  fi
}

function install_brew() {
  if ! type brew &>/dev/null; then
    $(command -v ruby) -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  fi
}

function install_brew_taps() {
  REQUIRED="
    heroku/brew
    homebrew/cask
    homebrew/cask-drivers
    homebrew/core
    homebrew/services
  "

  INSTALLED=$(brew tap)

  for i in $REQUIRED; do
    grep -q $i <<<$INSTALLED || brew tap $i
  done
}

function install_brew_formulas() {
  REQUIRED="
    awscli
    bash-completion
    circleci
    coreutils
    git
    go
    heroku
    imagemagick
    libmagic
    ncdu
    neovim
    postgresql
    python
    python@2
    rbenv
    redis
    shfmt
    terraform
    tree
  "

  INSTALLED=$(brew list)

  for i in $REQUIRED; do
    grep -q $i <<<$INSTALLED || brew install $i
  done
}

function install_brew_formulas_without_dependencies() {
  REQUIRED="
    yarn
  "

  INSTALLED=$(brew list)

  for i in $REQUIRED; do
    grep -q $i <<<$INSTALLED || brew install $i --ignore-dependencies
  done
}

function install_brew_casks() {
  REQUIRED="
    chromedriver
    docker
    google-backup-and-sync
    google-chrome
    keepassx
    postman
    slack
    spotify
    tunnelblick
    visual-studio-code
  "

  INSTALLED=$(brew cask list)

  for i in $REQUIRED; do
    grep -q $i <<<$INSTALLED || brew cask install $i
  done
}

function install_heroku_plugins() {
  REQUIRED="
    autocomplete
  "

  INSTALLED=$(heroku plugins)

  for i in $REQUIRED; do
    grep -q $i <<<$INSTALLED || heroku plugins:install $i
  done
}

function echoexec() {
  echo $@
  $@
}

cd files

for file in $(git ls-files); do
  target=$HOME/$file

  if [ ! -h $target ]; then
    if [ -f $target ]; then
      echoexec mv $target $target.backup
    fi

    echoexec ln -sfn $(pwd)/$file $target
  fi
done

set -v

install_nvm

install_brew

brew update

brew upgrade

install_brew_taps

install_brew_formulas

install_brew_formulas_without_dependencies

install_brew_casks

brew cleanup

brew doctor || true

git config --global core.editor "code --wait"
git config --global core.excludesfile "~/.gitignore"
git config --global fetch.prune true

install_heroku_plugins

pip2 install --upgrade \
  pip \
  setuptools

pip3 install --upgrade \
  pip \
  setuptools \
  virtualenv

echo "setup complete"
